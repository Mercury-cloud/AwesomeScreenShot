var win,menuType,type,tabid,taburl,tabtitle,zoomLevel,counter,ratio,scrollBar,data,tempDataUrl,currentWindowId,currentTabId,currentTabIndex,request,dataURL=[],newClickVersion="4.3.0",centerW=0,centerH=0,cameraStream=null,currentRecordingTabId="",currentRecordingTabTitle="",tabCameraClosedManually=!1,currentversion=chrome.app.getDetails().version,tabids={},recordType="",recordingStatus="",cVideo=null,centerOffX=0,centerOffY=0;function sendMessageToTab(e,t,a){chrome.tabs.sendMessage(e,t,a)}function sendMessage(e,t){chrome.runtime.sendMessage(e,t)}function getCurrentTab(t){chrome.tabs.query({active:!0,currentWindow:!0},function(e){t(e[0])})}function insertFile(a,o,r){return new Promise(function(t,e){"css"===a?chrome.tabs.insertCSS(o,{file:r},function(e){t(e)}):"script"===a&&chrome.tabs.executeScript(o,{file:r},function(e){t(e)})})}function getCameraStream(e,t,a){window.navigator.mediaDevices.getUserMedia({video:{deviceId:e,echoCancellation:!1,width:{ideal:1280},height:{ideal:720}}}).then(function(e){t(e)}).catch(function(e){})}function initCamera(e){getCameraStream(e,function(e){if(cameraStream=e,"tab"===recordType)currentRecordingTabId?sendMessageToTab(currentRecordingTabId,{action:"setup-camera"}):getCurrentTab(function(e){e.url.match(/chrome:\/\//)||e.url.match(/https:\/\/chrome.google.com\/webstore/i)?stopCameraStream():(sendMessageToTab(e.id,{action:"setup-camera"}),currentRecordingTabId=e.id)}),tabCameraClosedManually=!1;else{var t=document.querySelector("#camera-video");t.srcObject=e,t.play()}})}function stopCamera(){stopCameraStream(),"tab"===recordType?sendMessageToTab(currentRecordingTabId,{action:"stop-camera"}):sendMessage({action:"stop-camera"})}function stopCameraStream(){cameraStream&&(cameraStream.getTracks().forEach(function(e){e.stop()}),cameraStream=null,cVideo.srcObject=null)}function enablePriceCompare(){localStorage.pcnotification="true",localStorage.popupnotification="true",localStorage.barnotification="true",localStorage.show_feature_bar="false",refreshOptions()}function disablePriceCompare(){localStorage.pcnotification="false",localStorage.popupnotification="false",localStorage.barnotification="false","never"!==localStorage.show_feature_bar&&(localStorage.show_feature_bar="true"),refreshOptions()}function captureVisible(){type="visible",getSelectedTab(function(){chrome.windows.update(currentWindowId,{focused:!0},function(){chrome.tabs.update(currentTabId,{active:!0},function(){chrome.tabs.captureVisibleTab(null,{format:"png"},function(e){if(e){var t=document.createElement("IMG");t.src=e,dataURL.push(t),newTab()}})})})})}function captureSelected(){type="selected",getSelectedTab(checkContentScript)}function captureEntire(){type="entire",getSelectedTab(checkContentScript)}function getSelectedTab(t){getCurrentTab(function(e){tabid=e.id,taburl=e.url,tabtitle=e.title,chrome.tabs.getZoom(e.id,function(e){zoomLevel=e,null!=t&&t()})})}function checkContentScript(){chrome.tabs.executeScript(tabid,{file:"javascripts/isload.js"})}function saveAndScroll(){pushDataURL()}function pushDataURL(){chrome.tabs.update(currentTabId,{active:!0},function(){chrome.tabs.captureVisibleTab(currentWindowId,{format:"png"},function(e){var t=document.createElement("IMG");t.src=e,dataURL.push(t),sendMessageToTab(tabid,{action:"scroll_next"})})})}function updateShortcutsRequest(e){sendMessageToTab(e,{action:"update_shortcuts",msObj:localStorage.msObj})}function newTab(o){if(dataURL)if("selected"==menuType&&sendMessageToTab(tabid,{action:"destroy_selected"}),"true"==localStorage.autoSave)prepareImage();else{if(o&&"gmail"==o.type)var r="edit-react.html?"+o.type+"="+o.tabId;else r="edit-react.html";chrome.tabs.query({active:!0,currentWindow:!0},function(e){if(e&&e.length){if(o&&o.tabId)var t=e[0].index;else t=e[0].index+1;var a={url:r,index:t}}else a={url:r,index:currentTabIndex+1,windowId:currentWindowId};chrome.tabs.create(a,function(e){tabids[e.id]=tabid,tabid=e.id})})}else alert("Screen Capture Fail!!")}function prepareImage(){var y,k,_=document.getElementById("tempCanvas"),x=_.getContext("2d"),o=document.getElementById("test_image"),r=(document.getElementById("temp_image"),function(){var d,e;if(y=o.width,k=o.height,"visible"==type)w="selected"==menuType?(d=centerW*window.devicePixelRatio,e=centerH*window.devicePixelRatio,h=centerOffX,centerOffY):(d=o.width,e=o.height,h=0),$("#tempCanvas").attr({width:d,height:e}),x.drawImage(o,h*window.devicePixelRatio,w*window.devicePixelRatio,d,e,0,0,d,e),"jpg"==localStorage.format?tempDataUrl=_.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=_.toDataURL()),document.getElementById("pluginobj").AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),setTimeout(function(){getCurrentTab(function(e){sendMessageToTab(e.id,{action:"finishAutoSave",path:localStorage.savePath})}),sendMessage({action:"closeWin"})},1e3);else if("entire"==type||"selected"==type){var u=dataURL,g=j=n=0,t=u.length,m=counter,p=Math.round(t/m);function b(e,t,a,o,r,c,i,l,s){i=g*k,g==p-1&&(a=k-lastH,r=s=lastH),$("#temp_image").attr({src:e}).load(function(){$(this).unbind("load"),x.drawImage(this,t,a,o,r,c,i,l,s),++g>p-1?function(){if(++j>m-1){var e=document.getElementById("pluginobj");return"jpg"==localStorage.format?tempDataUrl=_.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=_.toDataURL()),e.AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),setTimeout(function(){getCurrentTab(function(e){sendMessageToTab(e.id,{action:"finishAutoSave",path:localStorage.savePath})}),sendMessage({action:"closeWin"})},1e3)}S=(f=j==m-1?(h=y-lastW,dw=d-j*y):(h=0,dw=y),j*y);w=0,v=dh=k,g=T=0,n=g+j*p,b(u[n],h,w,f,v,S,T,dw,dh)}():b(u[++n],t,a,o,r,c,i,l,s)})}function a(){$(_).attr({width:d,height:e})}if(!scrollBar.x&&scrollBar.y){y-=17,p=t,lastH=k*ratio.y,d="selected"==menuType?(scrollBar.realX&&(k-=17),centerW*window.devicePixelRatio):y,e=lastH?k*(p-1)+lastH:k*p,a();var h=0,f=dw=y,S=0,w=0,v=dh=k,T=0;b(u[n],h,w,f,v,S,T,dw,dh)}if(scrollBar.x&&!scrollBar.y){k-=17,m=t,lastW=y*ratio.x,e="selected"==menuType?(scrollBar.realY&&(y-=17),centerH*window.devicePixelRatio):k,d=lastW?y*(m-1)+lastW:y*m,a();h=0,f=dw=y,S=0,w=0,v=dh=k,T=0;!function e(t,a,o,r,n,c,i,l,s,d){c=j*y,j==m-1&&(a=y-lastW,r=l=lastW),$("#temp_image").attr({src:t}).load(function(){$(this).unbind("load"),x.drawImage(this,a,o,r,n,c,i,l,s),j<m-1&&e(u[++j],a,o,r,n,c,i,l,s)})}(u[n],h,w,f,v,S,T,dw,dh)}if(scrollBar.x&&scrollBar.y){lastW=y*ratio.x,lastH=k*ratio.y,y-=17,k-=17,e="selected"==menuType?(d=centerW*window.devicePixelRatio,centerH*window.devicePixelRatio):(d=lastW?y*(m-1)+lastW:y*m,lastH?k*(p-1)+lastH:k*p),a();h=0,f=dw=y,S=0,w=0,v=dh=k,T=0;b(u[n],h,w,f,v,S,T,dw,dh)}}dataURL=[],o.removeEventListener("onload",r,!1),o.src=""});o.onload=r,o.src=dataURL[0]}window.onload=function(){(cVideo=document.querySelector("#camera-video")).onloadedmetadata=function(){cVideo.requestPictureInPicture()},cVideo.onleavepictureinpicture=function(){stopCameraStream()},cVideo.onemptied=function(){document.exitPictureInPicture().catch(function(e){})}},localStorage.msObj||(localStorage.msObj='{"visible":{"enable":true,"key":"V"},"selected":{"enable":true,"key":"S"},"entire":{"enable":true,"key":"E"}}'),localStorage.format||(localStorage.format="png"),localStorage.delay_sec||(localStorage.delay_sec=3),localStorage["remove-print-watermark"]||(localStorage["remove-print-watermark"]=!1),localStorage["data-tracking"]||(localStorage["data-tracking"]=!0),localStorage["add-url"]||(localStorage["add-url"]=!1),localStorage["expand-link"]||(localStorage["expand-link"]=!0),localStorage["expand-link-slack"]||(localStorage["expand-link-slack"]=!0),localStorage["expand-link-trello"]||(localStorage["expand-link-trello"]=!0),localStorage["expand-link-asana"]||(localStorage["expand-link-asana"]=!0),localStorage["expand-link-github"]||(localStorage["expand-link-github"]=!0),localStorage["expand-link-jira"]||(localStorage["expand-link-jira"]=!0),localStorage["expand-link-gmail"]||(localStorage["expand-link-gmail"]=!0),localStorage.aws_s&&32!==localStorage.aws_s.length&&(localStorage.aws_s="",localStorage.aws_uid="",localStorage.aws_username=""),localStorage["show-noti"]||(localStorage["show-noti"]=!0),localStorage.popupTab||localStorage.version||(localStorage.popupTab="record"),localStorage["save-as"]||(localStorage["save-as"]=!0),localStorage.record_mic||(localStorage.record_mic=!0),localStorage.record_countdown||(localStorage.record_countdown=3),localStorage.max_resolution||(3e3<window.screen.width*window.devicePixelRatio?localStorage.max_resolution="1080":localStorage.max_resolution="720"),localStorage["save-location"]||(localStorage["save-location"]="cloud"),localStorage.reocrd_type||(localStorage.record_type="desktop"),localStorage["gmail-btn"]||(localStorage["gmail-btn"]="true"),$(document).ready(function(){}),localStorage.autoSave="false",chrome.runtime.onMessage.addListener(function(e,t,a){switch(getCurrentTab(function(e){e&&(/chrome-extension:\/\/nlipoenfbbikpbjkfpfillcgkoblgpmj/.test(e.url)||(currentWindowId=e.windowId,currentTabId=e.id,currentTabIndex=e.index))}),t.tab&&-1!=t.tab.id&&"visible"!=e.action&&"selected"!=e.action&&"entire"!=e.action&&"delay-capture"!==e.action||(menuType=e.action,e.menuType&&(menuType=e.menuType)),e.action){case"visible":"selected"==menuType&&(type="visible",centerW=e.centerW,centerH=e.centerH),dataURL=[],captureVisible(),getCurrentTab(function(e){sendMessageToTab(e.id,{action:"restorebar"})});break;case"selected":dataURL=[],captureSelected();break;case"entire":dataURL=[],captureEntire();break;case"delay-capture":type="delay",getSelectedTab(checkContentScript);break;case"https":alert("For security reason, Capture Selected Area doesn't work in https pages! Please try other options.");case"insert_script":insertFile("script",tabid,"javascripts/libs/jquery-3.4.0.min.js").then(insertFile("script",tabid,"javascripts/libs/dragresize.js")).then(insertFile("script",tabid,"javascripts/jquery.draggable.js")).then(insertFile("css",tabid,"stylesheets/selected.css")).then(insertFile("script",tabid,"javascripts/content_script.js")).then(function(){sendMessageToTab(tabid,"delay"===type?{action:"delay-capture",sec:localStorage.delay_sec}:{action:"init_"+menuType+"_capture"})});break;case"script_running":sendMessageToTab(tabid,"delay"===type?{action:"delay-capture",sec:localStorage.delay_sec}:{action:"init_"+type+"_capture"});break;case"check_shortcuts":updateShortcutsRequest(t.tab.id);break;case"update_shortcuts":chrome.tabs.getAllInWindow(null,function(e){for(var t=0,a=e.length;t<a;t++){var o=e[t],r=o.url;r.match(/https?:\/\/*\/*/gi)&&!r.match(/https:\/\/chrome.google.com\/extensions/i)&&updateShortcutsRequest(o.id)}});break;case"scroll_next_done":saveAndScroll();break;case"entire_capture_done":counter=e.counter,ratio=e.ratio,scrollBar=e.scrollBar,type="entire","selected"==menuType&&(centerW=e.centerW,centerH=e.centerH),sendMessageToTab(tabid,{action:"restorebar"}),newTab();break;case"capture_selected_done":type="visible",centerH=e.data.h,centerW=e.data.w,centerOffX=e.data.x,centerOffY=e.data.y,captureVisible();break;case"ready":return sendMessageToTab(tabid,{menuType:menuType,type:type,data:dataURL,taburl:taburl,tabtitle:tabtitle,counter:counter,ratio:ratio,scrollBar:scrollBar,centerW:centerW,centerH:centerH,centerOffX:centerOffX,centerOffY:centerOffY}),void(dataURL=[]);case"copy":chrome.experimental.clipboard.executeCopy(tabid,function(){alert("copied")});break;case"clearDataURL":dataURL=[];break;case"exit":getCurrentTab(function(e){chrome.tabs.remove(e.id)});break;case"get_option":a({options:localStorage.msObj});break;case"newtip":if(!localStorage.version||localStorage.version!=currentversion){chrome.browserAction.setBadgeText({text:""}),count=1,window.open("https://www.diigo.com/awe/new-for-awesome-screenshot.html?v="+currentversion),localStorage.version=currentversion,sendMessage({action:"shownew"})}break;case"openNewTab":var o=e.url;chrome.tabs.create({url:o});break;case"openOauthTab":o=e.url;chrome.tabs.create({url:o}),chrome.tabs.remove(t.tab.id);break;case"enablePriceCompare":enablePriceCompare(),localStorage.show_feature_bar="false";break;case"getShowFeatureBar":a(localStorage.show_feature_bar);break;case"disableShowFeatureBar":localStorage.show_feature_bar="never";break;case"desktop":e.type&&"gmail"==e.type?beginDesktop(t.tab.id):beginDesktop();break;case"record":"camera"!==(recordType=e.options.recordType)&&e.options.isRecordCam&&initCamera(e.options.camDeviceId),beginRecord(e.options);break;case"gmail-btn":a("true"==localStorage["gmail-btn"]);break;case"close-camera":!0===e.manually&&(tabCameraClosedManually=!0),stopCameraStream();break;case"init-camera":initCamera();break;case"getLocalStorage":var r=e.what,n={};r.forEach(function(e){n[e]="true"===localStorage[e]}),a(n)}}),chrome.tabs.onUpdated.addListener(function(e,t,a){"chrome-extension://alelhddbbhepgpmgidjdcjakblofbmce/#"==t.url?sendMessage({name:"loginByGoogle"}):"https://www.awesomescreenshot.com/redirect.html#"!=t.url&&"https://www.awesomescreenshot.com/redirect.html"!=t.url||(chrome.tabs.remove(a.id),a.openerTabId&&chrome.tabs.update(a.openerTabId,{active:!0}),chrome.runtime.sendMessage({name:"awsLoginByGoogle"})),e!==currentRecordingTabId||tabCameraClosedManually||sendMessageToTab(currentRecordingTabId,{action:"setup-camera"}),sendMessageToTab(e,{action:"tabupdate"})}),chrome.tabs.onRemoved.addListener(function(e){tabids[e]&&chrome.tabs.update(tabids[e],{selected:!0})}),localStorage.version&&localStorage.newClickVersion!=newClickVersion&&chrome.browserAction.setBadgeText({text:"New"}),"recording"!==recordingStatus&&chrome.browserAction.getBadgeText({},function(e){"New"!==e&&chrome.browserAction.setBadgeText({text:""})});var baseUrl="https://www.awesomescreenshot.com";function beginDesktop(n){chrome.desktopCapture.chooseDesktopMedia(["screen","window"],function(e){if(e){var t={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:3840,maxHeight:2160}}};window.navigator.mediaDevices.getUserMedia(t).then(function(o){var r=document.createElement("video");r.setAttribute("autoplay","true"),r.addEventListener("play",function(){setTimeout(function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=r.videoWidth,e.height=r.videoHeight,t.drawImage(r,0,0,e.width,e.height),dataURL=[];var a=document.createElement("IMG");a.src=e.toDataURL(),dataURL.push(a),r.pause(),r.srcObject=null,o.getVideoTracks()[0].stop(),$(r).remove(),$(e).remove(),tabtitle="Desktop screenshot",type="visible",menuType="desktop",n?newTab({type:"gmail",tabId:n}):newTab()},300)},!1),r.srcObject=o},function(e){alert(e)})}})}chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},function(e){e&&localStorage.version!=currentversion&&refreshCookie(),localStorage.version=currentversion});var createLogger=function(e){if("red"===e);else;},log_red=createLogger("red"),log=createLogger();function initVideo(e){socketClient&&(socketClient.active=!1),socketClient=new SocketClient(e),socketClient.connect()}function getDevices(e){return e.filter(function(t,e,a){return""!==t.label&&a.findIndex(function(e){return e.deviceId===t.deviceId})===e})}localStorage.video_need_complete&&(SocketClient.httpComplete(localStorage.video_need_complete),localStorage.video_need_complete=""),"true"!==localStorage.has_setup&&getAllAudioVideoDevices(function(e){e.audioInputDevices.length&&(0===getDevices(e.audioInputDevices).length&&chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},function(e){e?chrome.tabs.create({url:"/setup-react.html?isSignIn=true"}):chrome.tabs.create({url:"/setup-react.html"})}))});