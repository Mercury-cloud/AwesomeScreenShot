var getMicFrame=null,audioStream=null,cameraStream=null,videoStream=null,tempVideo=null,MIME_TYPE="video/webm",file_name="/awesome/record.webm",currentId=null,tempFileInfo=null,currentSize=null,currentName=null,currentSaveName=null,fileCreated=!1,currentInfo=null,twoHoursCount=1,isRecording=!1,recordingStatus="",isRecordingPaused=!1,recordingTime=0,recordingTimer=null,lastPausingTime=null,pausedTime=null,recoder=null,currentRecordType="",tabSoundAudioPlayer=null,isPremium=!1,recordingStartTime=null,count=0,socketClients=[],socketClient=null;function resetData(){dataArray=new ArrayBuffer(0),audioArray=new ArrayBuffer(0)}function getPremium(){return new Promise(function(r,e){chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(e){e&&"1"==e.value?r(!0):r(!1)})})}function getSaveName(){if("desktop"===currentRecordType)var e="Desktop";else if("tab"===currentRecordType)e="Tab";else if("camera"===currentRecordType)e="Camera";return e+"-"+(new Date).getTime()}function getFormatName(){if("desktop"===currentRecordType||"tab"===currentRecordType)return currentRecordingTabTitle;if("camera"===currentRecordType){var e=new Date;return"Camera-"+(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+"-"+e.getHours()+"-"+e.getMinutes()+"-"+e.getSeconds())}}var baseUrl="https://www.awesomescreenshot.com";function refreshCookie(){$.get(baseUrl+"/promotion_ex")}function goToUpgrade(t){var o="https://www.awesomescreenshot.com";chrome.cookies.get({url:o,name:"screenshot_personal_type"},function(e){if(e)var r="/pricing?from="+t;else r="/user/login?type=record_screen";chrome.tabs.create({url:o+r})})}function getMic(e){return window.navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:e}}})}function getStream(e,r,n){if("1080"===localStorage.max_resolution)var a=1920,i=1080;else if("720"===localStorage.max_resolution)a=1280,i=720;else a=3840,i=2160;return new Promise(function(t,o){if("tab"==e)chrome.tabCapture.capture({audio:r,video:!0,videoConstraints:{mandatory:{chromeMediaSource:"tab",maxWidth:a,maxHeight:i}}},function(e){if(e)t(e);else{var r=chrome.runtime.lastError.message;alert("Get tab stream error, please refresh the page and try again.",r)}});else if("desktop"==e){chrome.desktopCapture.chooseDesktopMedia(["screen","window","audio"],function(e){if(e){var r={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:a,maxHeight:i,maxFrameRate:30}},optional:[]};window.navigator.mediaDevices.getUserMedia(r).then(t).catch(o)}else stopCamera()})}else"camera"==e&&getCameraStream(n,function(e){cameraStream=e,chrome.windows.create({url:"/camera.html?type=camera",type:"popup"}),t(e)},function(e){o(e)})})}function setBadge(e,r){"text"===e?chrome.browserAction.setBadgeText({text:r}):"color"===e&&chrome.browserAction.setBadgeBackgroundColor({color:r})}function doBeginRecord(e,r){if(setBadge("color","red"),0<e.countdown)var t=parseInt(e.countdown),o=setInterval(function(){setBadge("text",t+""),0==t&&(clearInterval(o),setBadge("text","REC"),gotStream(r,e)),t--},1e3);else gotStream(r,e)}function beginRecord(r){currentRecordType=r.recordType,r.isRecordMic&&getMic(r.micDeviceId).then(function(e){audioStream=e}),getCurrentTab(function(e){currentRecordingTabTitle=e.title}),getStream(r.recordType,r.isRecordTabSound,r.camDeviceId).then(function(e){if(videoStream=e,recordingStatus="preparing","local"===r.saveLocation?doBeginRecord(r,videoStream):initVideo({onopen:function(){doBeginRecord(r,videoStream)},onError:function(){},onClose:function(){}}),"tab"===r.recordType&&r.isRecordTabSound){tabSoundAudioPlayer=new Audio;try{tabSoundAudioPlayer.srcObject=videoStream}catch(e){tabSoundAudioPlayer.src=window.URL.createObjectURL(videoStream)}tabSoundAudioPlayer.volume=1,tabSoundAudioPlayer.play()}}).catch(function(e){})}function handleBlob(r){if("local"===localStorage["save-location"]){if(count++,r)if(fileCreated){fileSaver.append(r,currentSaveName),currentSize+=r.size;var e=bytesToSize(currentSize);currentInfo.detail.size=e,currentInfo.detail.duration=recordingTime,DB.update(currentId,currentInfo)}else currentName=getFormatName(),currentSaveName=getSaveName(),fileSaver.save(r,currentSaveName).then(function(e){fileCreated=!0,currentSize=r.size,tempFileInfo={fileUrl:e,title:currentName,size:bytesToSize(currentSize),duration:recordingTime},DB.save(tempFileInfo).then(function(e){currentId=e.id,currentInfo=e})})}else socketClient.send(r)}function gotStream(e,r){var t={type:"video",disableLogs:!1,getNativeBlob:!0,timeSlice:"local"===localStorage["save-location"]?3e3:500,ondataavailable:handleBlob};if(!t.videoCodec)var o="vp8";if(o&&(t.mimeType="video/webm; codecs="+o.toLowerCase()),audioStream){var n=new MediaStream;getMixedAudioStream([audioStream,e]).getAudioTracks().forEach(function(e){n.addTrack(e)}),e.getVideoTracks().forEach(function(e){n.addTrack(e)}),e=n}recorder=new RecordRTC(e,t);try{recorder.startRecording(),alreadyHadGUMError=!1}catch(e){getUserMediaError()}isRecording=!0,recordingStatus="recording",videoStream.onended=function(e){videoStream&&(videoStream.onended=function(){}),audioStream&&audioStream.stop(),cameraStream&&cameraStream.stop(),stopScreenRecording(e)},videoStream.getVideoTracks()[0].onended=function(){videoStream&&videoStream.onended&&videoStream.onended()},recordingStartTime=(new Date).getTime(),recordingTimer=setInterval(updateRecordingTime,100)}function checkTimeLength(e){"cloud"===localStorage["save-location"]?72e5*twoHoursCount<=e&&e<=72e5*twoHoursCount+100&&(chrome.windows.create({type:"popup",url:"/notification.html",left:0,top:0,width:300,height:320,focused:!0}),twoHoursCount++):301e3<=e&&getPremium().then(function(e){e||stopStream()})}function getMixedAudioStream(e){var t=new AudioContext,o=[],n=t.createGain();n.connect(t.destination);var a=n.gain.value=0;if(e.forEach(function(e){if(e.getAudioTracks().length){a++;var r=t.createMediaStreamSource(e);r.connect(n),o.push(r)}}),a){var r=t.createMediaStreamDestination();return o.forEach(function(e){e.connect(r)}),r.stream}}function updateRecordingTime(){if(!isRecordingPaused){var e=(new Date).getTime()-recordingStartTime;pausedTime&&(e-=pausedTime),checkTimeLength(e),setBadge("text",recordingTime=secondsToTime(e))}}function secondsToTime(e){e=Math.floor(e/1e3);var r=Math.floor(e/3600),t=e%60;return t<10&&(t="0"+t),(0<r?r+":":"")+Math.floor((e-3600*r)/60)+":"+t}function setDefaults(){videoStream&&(videoStream.getTracks().forEach(function(e){e.stop()}),videoStream.onended&&videoStream.onended()),tabSoundAudioPlayer=null,audioStream&&audioStream.stop(),cameraStream&&stopCamera(),recorder=null,isRecording=!1,recordingStatus="",recordingTime=0,tempFileInfo=recordingStartTime=videoStream=null,imgIndex=0,fileCreated=isRecordingPaused=!1,currentInfo=currentSaveName=currentName=currentSize=tempFileInfo=currentId=null,twoHoursCount=1,clearInterval(recordingTimer),pausedTime=lastPausingTime=recordingTimer=null,currentRecordingTabId="",currentRecordingTabTitle="",tabCameraClosedManually=!1,setBadge("text","")}function pauseScreenRecording(){isRecordingPaused||("local"!==localStorage["save-location"]&&socketClient.pause(),recorder.pauseRecording(),isRecordingPaused=!0,lastPausingTime=(new Date).getTime())}function resumeScreenRecording(){"local"!==localStorage["save-location"]&&"connected"!==socketClient.status?socketClient.reConnect():(recorder.resumeRecording(),isRecordingPaused=!1,pausedTime=pausedTime+(new Date).getTime()-lastPausingTime)}function stopStream(e){videoStream&&videoStream.onended(e)}function restoreRecording(){isRecording=!1,recordingStatus="",clearInterval(recordingTimer),pausedTime=lastPausingTime=recordingTimer=null,currentRecordingTabId="",tabCameraClosedManually=!1,setBadge("text",""),videoStream&&videoStream.getTracks().forEach(function(e){e.stop()})}function stopScreenRecording(r){recorder.stopRecording(function(){if(googleEvent("record video","record video"),cameraStream&&stopCamera(),"local"===localStorage["save-location"])r?DB.delete(currentId):chrome.tabs.create({url:"/video-react.html?id="+currentId});else if(r){var e=socketClient.videoName.match(/-(.*)\.webm/)[1];socketClient.needReconnect=!1,socketClient.sentQueue=[],socketClient.willSendQueue=[],socketClient.close(1e3),$.ajax({method:"POST",url:"https://www.awesomescreenshot.com/api/v1/video/delete_video",data:JSON.stringify({videoID:e})})}else socketClient.complete(),chrome.tabs.create({url:socketClient.videoURI});setDefaults()}),recordingTimer&&clearTimeout(recordingTimer)}function getFileSize(e){var r=(e/1024).toFixed(2);return r=r<1024?r.toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" KB":(r=(r/1024).toFixed(2)).toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" MB"}function saveVideo(){var r="AwesomeScreenshot-"+(new Date).toLocaleString().replace(/\s/g,""),e=(new File([recorder.getBlob()],r+".webm",{type:"video/webm"}),recorder.getBlob()),t=bytesToSize(e.size);fileSaver.save(e,r+".webm").then(function(e){DB.save({fileUrl:e,title:r,size:t,duration:recordingTime}).then(function(e){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?id="+e}),setDefaults()})})})}function googleEvent(e,r){ga&&ga("send","event","chrome extension",e,r)}function getOS(){window.navigator.userAgent;var e=window.navigator.platform,r=null;return-1!==["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(e)?r="Mac OS":-1!==["Win32","Win64","Windows","WinCE"].indexOf(e)?r="Windows":!r&&/Linux/.test(e)&&(r="Linux"),r}chrome.cookies.get({url:baseUrl,name:"screenshot_personal_type"},function(e){void 0===e&&refreshCookie()}),$(document).ready(function(){}),DB.init(),window.addEventListener("message",function(e){"audioStream"==e.data.type&&(audioStream=e.data.steam)},!1),chrome.commands.onCommand.addListener(function(e){"stop-recording"===e?stopStream():"pause-or-resume-recording"===e&&(isRecordingPaused?resumeScreenRecording():pauseScreenRecording())});