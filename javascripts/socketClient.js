var preivewConfig={ws:"wss",domain:"preview.awesomescreenshot.com",cookie:"awesomescreenshot.com"},wwwConfig={ws:"wss",domain:"www.awesomescreenshot.com",cookie:"awesomescreenshot.com"},awsConfig={ws:"ws",domain:"www.aws.cn",cookie:"aws.cn"},config=wwwConfig;function SocketClient(e){this.active=!0,this.URL=config.ws+"://"+config.domain+"/websocket/video/open",this.socket=null,this.status="unconnected",this.sentQueue=[],this.willSendQueue=[],this.currentSendId=1,this.option=e,this.retryCount=0,this.retryTimeout=null,this.videoURI="",this.paused=!1,this.lock=!1,this.videoName="",this.needReconnect=!0,this.lastOnLine=!0}SocketClient.prototype.connect=function(){var i=this;clearTimeout(i.retryTimeout),i.retryTimeout=null,i.socket=new WebSocket(this.URL+"?time="+(new Date).getTime()),i.socket.binaryType="blob",i.socket.onopen=function(){i.status="connected",chrome.cookies.getAll({domain:config.cookie},function(e){var t="",n="";if(e.forEach(function(e){"screenshot_personal_session_id"===e.name?t=e.value:"screenshot_personal_uid"===e.name&&(n=e.value)}),i.videoName)i.socket.send(JSON.stringify({type:"recover",videoName:i.videoName,token:t,userID:n}));else{var o=getFormatName();i.socket.send(JSON.stringify({type:"init",title:o,token:t,userID:n,extra:{userAgent:navigator.userAgent,client:"chrome extension",extVersion:currentversion,recordType:currentRecordType,screenSize:window.screen.width*window.devicePixelRatio+"*"+window.screen.height*window.devicePixelRatio}}))}})},i.socket.onclose=function(e){i.status="unconnected",!isRecordingPaused&&i.needReconnect&&i.reConnect(),i.needReconnect||(i.needReconnect=!0)},i.socket.onerror=function(e){},i.socket.onmessage=function(e){if(e.data){var t=JSON.parse(e.data);if("slice"===t.type){var n=i.sentQueue.findIndex(function(e){return e.id===Number(t.id)});i.sentQueue.splice(n,1)}else"init"===t.type?("1"===t.status?(i.videoURI=t.videoURI,i.videoName=t.videoName,i.option&&i.option.onopen()):(setDefaults(),i.needReconnect=!1),i.retryCount=0):"recover"===t.type?("1"===t.status?((isRecordingPaused||i.paused)&&(i.paused=!1,i.active&&resumeScreenRecording()),i.resendSent(Number(t.id))):"2"===t.status||(i.active&&stopStream(),i.needReconnect=!1),i.retryCount=0):"complete"===t.type&&(i.needReconnect=!1,i.sentQueue=[],i.willSendQueue=[],i.close(1e3))}}},SocketClient.prototype.reConnect=function(){var e=this;e.status="reconnecting",e.socket=null,e.retryCount<5?(0===e.retryCount?e.connect():setTimeout(function(){e.connect()},2500),e.retryCount++):("recording"!==recordingStatus?(e.needReconnect=!1,e.active&&setDefaults()):e.handleError(),e.retryCount=1)},SocketClient.prototype.complete=function(){var t=this;"connected"===t.status?(t.socket.send(JSON.stringify({type:"complete",videoName:this.videoName})),t.sentQueue.push({type:"complete",videoName:this.videoName})):SocketClient.httpComplete(t.videoName).then(function(e){1===e.code?t.active&&(localStorage.video_need_complete=""):(t.sentQueue=[],t.willSendQueue=[])}),t.active=!1},SocketClient.prototype.pause=function(){"connected"===this.status&&(this.socket.send(JSON.stringify({type:"pause",videoName:this.videoName})),localStorage.video_need_complete=this.videoName)},SocketClient.prototype.close=function(e){e=e||1e3,this.socket&&(this.socket.close(e),this.status="unconnected",this.socket=null)},SocketClient.prototype.sendWillsend=function(){var t=this,e=t.willSendQueue.slice();t.willSendQueue=[],e.forEach(function(e){t.send(e)})},SocketClient.prototype.resendSent=function(t){var n=this;n.lock=!0,n.sentQueue.forEach(function(e){e.id?e.id>t&&n.send(e.data,!0):"complete"===e.type&&n.socket.send(JSON.stringify(e))}),n.lock=!1},SocketClient.prototype.checkData=function(){this.sentQueue.length;var e=this.willSendQueue.length;150<e&&this.handleError()},SocketClient.prototype.send=function(e,t){var n=this;!n.lastOnLine&&window.navigator.onLine,"connected"!==n.status?n.willSendQueue.push(e):t?window.navigator.onLine?n.socket.send(e):n.willSendQueue.push(e):window.navigator.onLine&&!0!==this.lock?0!==this.willSendQueue.length?(n.willSendQueue.push(e),n.sendWillsend()):(n.sentQueue.push({id:n.currentSendId,data:e}),n.socket.send(e),n.currentSendId++):(window.navigator.onLine,n.willSendQueue.push(e)),n.lastOnLine=window.navigator.onLine,n.checkData()},SocketClient.prototype.handleError=function(e){this.needReconnect=!0,isRecordingPaused||this.active&&pauseScreenRecording(),this.paused=!0,chrome.browserAction.setBadgeText({text:"!"})},SocketClient.httpComplete=function(e){return $.ajax({method:"POST",url:"http://"+config.domain+"/api/v1/video/complete",contentType:"application/json; charset=utf-8",data:JSON.stringify({videoName:e})})};